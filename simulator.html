<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <style type="text/css">
    @font-face {
      font-family: 'Vollkorn';
      font-style: normal;
      font-weight: normal;
      src: local('Vollkorn Regular'), local('Vollkorn-Regular'),
        url('./fonts/Vollkorn-Regular.woff') format('woff');
      unicode-range: U+30-39, U+28-29;
    }

    @font-feature-values Vollkorn {
      @styleset { boring-one: 11; }
    }

    @font-face {
      font-family: 'Vollkorn';
      font-style: normal;
      font-weight: bold;
      src: local('Vollkorn Bold'), local('Vollkorn-Bold'),
        url('./fonts/Vollkorn-Bold.woff') format('woff');
      unicode-range: U+30-39;
    }

    body {
      --blue: #aae;
      --module-border-width: 0.25rem;
      --module-border-radius: 0.75rem;

      font-family: sans-serif;
      padding: 0.5rem;
      margin: 0;
    }

    .module {
      margin-bottom: 0.5rem;
      box-sizing: border-box;
      overflow: hidden;
      min-width: fit-content;
    }

    .module > .move-controls {
      display: inline;
      margin-bottom: 0;
    }

    .module > .move-controls > * {
      cursor: default;
      font-size: 0.75em;
      color: #888;
    }

    .module > .move-controls > *:hover {
      color: #ccc;
    }

    .module > .title {
      cursor: default;
      margin-left: calc(var(--module-border-radius) - (var(--module-border-width) / 2));
      margin-bottom: 0;
      font-size: 0.75em;
      font-weight: normal;
      color: #555;
      display: inline;
    }

    .module > .title:hover {
      color: #999;
    }

    .module.collapsed > .title {
      border-bottom-color: #555;
      border-bottom-style: dotted;
      border-bottom-width: 1px;
    }

    .module.collapsed > .title:hover {
      border-bottom-color: #999;
    }

    .module > .content {
      border-style: solid;
      border-color: #ccc;
      border-width: var(--module-border-width);
      border-radius: var(--module-border-radius);
      padding: calc((var(--module-border-radius) - (var(--module-border-width) / 2)) - var(--module-border-width));
    }

    .module.collapsed > .content {
      display: none;
    }

    .module > .content .section {
      margin-bottom: 0.5em;
    }

    .module > .content .section:last-child {
      margin-bottom: 0;
    }

    .module > .content .section .heading {
      font-size: 0.75em;
      font-weight: normal;
      color: #555;
      border-bottom-style: solid;
      border-bottom-color: #ccc;
      border-bottom-width: 1px;
      margin-bottom: 0.5rem;
    }

    #sources > .content table {
      border-collapse: collapse;
      width: 100%;
    }

    #sources > .content table td, #sources > .content table th {
      padding: 0 1em 0 0;
    }

    #sources > .content table td:last-child, #sources > .content table th:last-child {
      padding: 0;
    }

    #sources > .content table th {
      font-weight: normal;
      font-size: 0.75em;
      text-align: left;
      border-bottom-style: solid;
      border-bottom-width: 1px;
      border-bottom-color: #ccc;
      color: #555;
    }

    #rotor {
      float: left;
      width: 540px;
      height: 540px;
      margin-right: 0.5rem;
    }

    #rotor text {
      font-family: 'Vollkorn';
      font-feature-settings: 'onum';
      font-variant-numeric: oldstyle-nums;
      font-variant-alternates: styleset(boring-one);
    }

    #circle {
      fill: none;
      stroke: var(--blue);
      stroke-width: 10;
    }

    #arrow-target {
      transition: transform 0.5s;
    }

    #arrow-target path {
      fill: none;
      stroke: var(--blue);
      stroke-width: 5;
      stroke-dasharray: 10;
    }

    #arrow-target text {
      fill: var(--blue);
      font-weight: bold;
      font-size: 20px;
    }

    .coordinates {
      letter-spacing: 0.1em;
      font-size: 15px;
      font-weight: 400;
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }

    #target-coordinates {
      fill: var(--blue);
    }

    #rotor-coordinates {
      fill: black;
    }

    #arrow {
      transition: transform 0.5s;
      transition-timing-function: linear;
    }

    #arrow path {
      fill: black;
    }

    #arrow text {
      fill: #ffffff;
      font-weight: 700;
      font-size: 20px;
    }

    .limit {
      transition: transform 1s;
    }

    .symbol:hover ~ .box, .symbol:hover ~ text {
      visibility: visible;
    }

    .limit text {
      fill: white;
      font-weight: bold;
      font-size: 20px;
      visibility: hidden;
    }

    .limit .box {
      visibility: hidden;
    }

    #negative-limit .symbol {
      fill: #a55;
    }

    #negative-limit.active .symbol {
      fill: #f00;
      filter: url(#glow);
    }

    #positive-limit .symbol {
      fill: #5a5;
    }

    #positive-limit.active .symbol {
      fill: #0f0;
      filter: url(#glow);
    }

    #negative-limit .box {
      fill: var(--blue);
    }

    #positive-limit .box {
      fill: var(--blue);
    }

    #n {
      transition: transform 0.5s;

      fill: black;
    }
  </style>

  <link rel="stylesheet" type="text/css" href="./widgets.css" />
  <script type="text/javascript" src="./widgets.js"></script>

  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var textBox1 = chapatt.TextBox.new(document.getElementById('text-box-1'));
        textBox1.getValueModel().signalConnect('valueChanged', function() {
            console.log('text-box-1: valueChanged');
        });

        var toggleButtonGroup1 = chapatt.ToggleButtonGroup.new(document.getElementById('toggle-button-group-1'));
            toggleButtonGroup1.valueModel.signalConnect('valueChanged', function(targetWidget, signalName, signalData, userData) {
                console.log('toggle-button-group-1: valueChanged from ' + toggleButtonGroup1.valueModel.getValue() + ' to ' + signalData);
        });

        var angleUnits = [
            chapatt.Unit.new('degrees', 'deg',
                function(valueAsThis) {
                    return valueAsThis;
                },
                function(valueAsDefault) {
                    return valueAsDefault;
                }
            )
        ];

        /* Bearing */
        var bearingSlider = chapatt.Slider.new(document.getElementById('bearing-slider'), angleUnits, 0, 360);

        function bearingButtonCallback(targetWidget, signalName, signalData, userData) {
            bearingSlider.field.saveFieldText();
/*
            rotorTargetToBearing(bearingSlider.getValueModel().getValue());
            sendBearing(bearingSlider.getValueModel().getValue());
*/
            rotorTargetToBearing(bearingSlider.getValueModel().getValue());
        }
        var bearingButton = chapatt.Button.new(document.getElementById('bearing-button'), 1);
        bearingButton.signalConnect('clicked', bearingButtonCallback, null);

        /* Heading */
        var headingSlider = chapatt.Slider.new(document.getElementById('heading-slider'), angleUnits, 0, 360);

        function headingButtonCallback(targetWidget, signalName, signalData, userData) {
            headingSlider.field.saveFieldText();
            setHeading(headingSlider.getValueModel().getValue());
        }
        var headingButton = chapatt.Button.new(document.getElementById('heading-button'), 1);
        headingButton.signalConnect('clicked', headingButtonCallback, null);

        /* CCW Limit */
        var negativeLimitSpinBox = chapatt.SpinBox.new(document.getElementById('negative-limit-spin-box'), angleUnits);

        function negativeLimitButtonCallback(targetWidget, signalName, signalData, userData) {
            negativeLimitSpinBox.field.saveFieldText();
            negativeLimitToBearing(negativeLimitSpinBox.getValueModel().getValue());
        }
        var negativeLimitButton = chapatt.Button.new(document.getElementById('negative-limit-button'), 1);
        negativeLimitButton.signalConnect('clicked', negativeLimitButtonCallback, null);

        var positiveLimitSpinBox = chapatt.SpinBox.new(document.getElementById('positive-limit-spin-box'), angleUnits);

        function positiveLimitButtonCallback(targetWidget, signalName, signalData, userData) {
            positiveLimitSpinBox.field.saveFieldText();
            positiveLimitToBearing(positiveLimitSpinBox.getValueModel().getValue());
        }
        var positiveLimitButton = chapatt.Button.new(document.getElementById('positive-limit-button'), 1);
        positiveLimitButton.signalConnect('clicked', positiveLimitButtonCallback, null);
    });
  </script>

  <script type="text/javascript">
    var ws;

    document.addEventListener("DOMContentLoaded", function() {
        try {
            ws = new WebSocket("ws://" + window.location.hostname + ":2345");
        } catch (error) {
            console.error(error);
        }
        if (ws) {
            ws.onmessage = function(event) {
                console.log(event.data);
                rotorToBearing(event.data);
            };
        }

        var modules = Array.from(document.getElementsByClassName('module'));
        modules.forEach(function(module) {
            var title = module.getElementsByClassName('title')[0];
            title.addEventListener('click', function() {
                module.classList.toggle("collapsed");
            });

            var down = module.getElementsByClassName('move-controls')[0].getElementsByClassName('down')[0];
            down.addEventListener('click', function() {
                if (module.nextElementSibling)
                    module.parentNode.insertBefore(module, module.nextElementSibling.nextElementSibling);
            });

            var up = module.getElementsByClassName('move-controls')[0].getElementsByClassName('up')[0];
            up.addEventListener('click', function() {
		if (module.previousElementSibling)
                    module.parentNode.insertBefore(module, module.previousElementSibling);
            });
        });
    });

    Number.prototype.coterminalInTurn = function(turn, base=360) {
        if ((positiveInFirstTurn = this % base) < 0) {
            positiveInFirstTurn += base
        }

        var fullTurns = (Math.abs(turn) - 1) * base;
        if (turn > 0)
            return positiveInFirstTurn + fullTurns;
        else
            return (positiveInFirstTurn - (positiveInFirstTurn == 0 ? 0 : base)) - fullTurns;
    };

    function sendBearing(bearing) {
        ws.send(bearing); 
    }

    function rotorTargetToBearing(bearing) {
        document.getElementById('arrow-target').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#arrow-target text').textContent = bearing + "°";
    }

    function rotorToBearing(bearing) {
        document.getElementById('arrow').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#arrow text').textContent = bearing + "°";
    }

    function calculateNegativeLimitBox() {
        var bbox = document.querySelector('#negative-limit text').getBBox();
        document.querySelector('#negative-limit .box').setAttribute("width", bbox.width + 10);
        document.querySelector('#negative-limit .box').setAttribute("x", -bbox.width - 15);
    }

    function negativeLimitToBearing(bearing) {
        document.getElementById('negative-limit').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#negative-limit text').textContent = bearing + "°";

        var normalizedBearing = bearing.coterminalInTurn(1);
        if (normalizedBearing > 90 && normalizedBearing < 270) {
            var bbox = document.querySelector('#negative-limit text').getBBox();
            document.querySelector('#negative-limit text').setAttribute("transform", "rotate(180 " + (bbox.x + (bbox.width / 2)) + " " + (bbox.y + (bbox.height / 2)) + ")");
        } else {
            document.querySelector('#negative-limit text').setAttribute("transform", "");
        }

        calculateNegativeLimitBox();
    }

    function setNegativeLimitActive(active) {
        negativeLimit = document.getElementById('negative-limit');
        classes = negativeLimit.classList;
        if (active)
            classes.add("active");
        else
            classes.remove("active");
    }

    function calculatePositiveLimitBox() {
        var bbox = document.querySelector('#positive-limit text').getBBox();
        document.querySelector('#positive-limit .box').setAttribute("width", bbox.width + 10);
    }

    function positiveLimitToBearing(bearing) {
        document.getElementById('positive-limit').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#positive-limit text').textContent = bearing + "°";

        var normalizedBearing = bearing.coterminalInTurn(1);
        if (normalizedBearing > 90 && normalizedBearing < 270) {
            var bbox = document.querySelector('#positive-limit text').getBBox();
            document.querySelector('#positive-limit text').setAttribute("transform", "rotate(180 " + (bbox.x + (bbox.width / 2)) + " " + (bbox.y + (bbox.height / 2)) + ")");
        } else {
            document.querySelector('#positive-limit text').setAttribute("transform", "");
        }

        calculatePositiveLimitBox();
    }

    function setPositiveLimitActive(active) {
        positiveLimit = document.getElementById('positive-limit');
        classes = positiveLimit.classList;
        if (active)
            classes.add("active");
        else
            classes.remove("active");
    }

    function setHeading(heading) {
        document.getElementById('n').setAttribute("transform", "rotate(" + -heading + " 270 270)");
    }
  </script>
</head>
<body>
  <svg
    id="rotor"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    width="540"
    height="540"
  >
    <defs>
      <!-- start node x = (55 * cos(pi * 0.34)) = 26.49645 -->
      <!-- node y = -(55 * sin(pi * 0.34)) = -48.19687 -->
      <!-- end node x = (55 * cos(pi * 0.66)) = -26.49645 -->
      <path
        id="target-bearing-window"
        d="m 26.49645 -48.19687
           A 55 55 0 0 0 -26.49645 -48.1968"
        stroke-width="27"
      />
      <g id="limit-symbol">
        <path
          class="arrow"
          d="m 10 -220
             l -10 10
             l 10 10
             z"
        />
        <rect
          class="bar"
          x="-5"
          y="-220"
          width="5"
          height="20"
        />
      </g>
      <path
        id="coordinate-path"
        transform="translate(270 270)"
        d="m -200 0
           A 200 200 0 0 0 200 0"
      />
      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox">
        <feGaussianBlur stdDeviation="5" result="coloredBlur"/>
        <feMerge>
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    <circle
      id="circle"
      cx="270"
      cy="270"
      r="210"
    />
    <!-- 70 * tan(60deg.) = 121.243557 -->
    <!-- 20 * cos(30deg.) = 17.32051 -->
    <!-- 25 + 17.32051 = 42.32051 -->
    <!-- 121.243557 + 17.32051 + 10 = 148.56406 -->
    <!-- 70 + 17.32051 = 87.32051 -->
    <g id="arrow-target"><g transform="translate(270 270)">
      <path
        d="m -45 -60
           v 150
           h 90
           v -150
           h 42.32051
           l -87.32051 -148.56406
           l -87.32051 148.56406
           z"
      />
      <text x="0" y="-50" text-anchor="middle">0°</text>
    </g></g>
    <text text-anchor="start" id="rotor-coordinates" class="coordinates">
      <textPath xlink:href="#coordinate-path">
        37°28′14″N -70°65′91″W
      </textPath>
    </text>
    <text text-anchor="end" id="target-coordinates" class="coordinates">
      <textPath xlink:href="#coordinate-path" startOffset="100%">
        37°28′14″N -70°65′91″W
      </textPath>
    </text>
    <g id="arrow"><g transform="translate(270 270)">
      <mask id="target-bearing-window-mask">
        <rect x="-50%" y="-50%" width="100%" height="100%" fill="white" />
        <use
          xlink:href="#target-bearing-window"
          stroke="black"
        />
        <use
          xlink:href="#target-bearing-window"
          stroke="black"
          transform="rotate(180 0 0)"
        />
      </mask>
      <path
        d="m -35 -70
           v 150
           h 70
           v -150
           h 35
           l -70 -121.243557
           l -70 121.243557
           z"
        mask="url(#target-bearing-window-mask)"
      />
      <text x="0" y="-80" text-anchor="middle">0°</text>
    </g></g>
    <g id="negative-limit" class="limit"><g transform="translate(270 270)">
      <use xlink:href="#limit-symbol" class="symbol" />
      <rect
        class="box"
        x="-25"
        y="-225"
        width="20"
        height="30"
        rx="10"
        ry="10"
      />
      <text x="-10" y="-205" text-anchor="end">0°</text>
    </g></g>
    <g id="positive-limit" class="limit"><g transform="translate(270 270)">
      <use xlink:href="#limit-symbol" class="symbol" transform="scale(-1 1)" />
      <rect
        class="box"
        x="5"
        y="-225"
        width="20"
        height="30"
        rx="10"
        ry="10"
      />
      <text x="10" y="-205" text-anchor="start">0°</text>
    </g></g>
    <!-- (40 - x) ^ 2 + 14 ^ 2 = ((14 / 8) * x)^2 -->
    <!-- x = (-640 / 33) + ((56 sqrt(433)) / 33) = 15.91771 -->
    <!-- 40 - 15.91771 = 24.08229 -->
    <g id="n"><path
      transform="translate(270 270)"
      d="m -15 -225
         v -40
         h 8
         l 14,24.08229
         v -24.08229
         h 8
         v 40
         h -8
         l -14,-24.08229
         v 24.08229
         z"
    /></g>
  </svg>
  <ol id="modules">
    <li id="sources" class="module collapsed">
      <h2 class="title">Data Sources</h2>
      <div class="move-controls"><span class="down">&#x25bc;</span><span class="up">&#x25b2;</span></div>
      <div class="content">
        <table>
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Status</th>
          </tr>
          <tr>
            <td>Bow</td>
            <td>(0.5, 6)</td>
            <td>Connected</td>
          </tr>
          <tr>
            <td>Stern</td>
            <td>(0, -12)</td>
            <td>Connected</td>
          </tr>
        </table>
      </div>
    </li>
    <li class="module">
      <h2 class="title">Relative Bearing</h2>
      <div class="move-controls"><span class="down">&#x25bc;</span><span class="up">&#x25b2;</span></div>
      <div class="content">
        <div style="margin-bottom: 0.5em">
          <ul id="toggle-button-group-1" class="example-widget example-button-group">
            <li class="example-button example-toggle-button button">
              <div>Auto</div>
            </li>
            <li class="example-button example-toggle-button button selected">
              <div>Manual</div>
            </li>
          </ul>
        </div>
        <div>
          <div id="bearing-slider" class="example-widget example-slider" style="margin-right: 0.25em">
            <div class="bar" style="width: 50%;"></div>
            <div class="overlay">
              <div class="decrease">
                <div style="font-size: 0.6em;">&#x25c0;</div>
              </div>
              <div class="label">
                <div>Bearing:</div>
              </div>
              <div class="increase">
                <div style="font-size: 0.6em;">&#x25b6;</div>
              </div>
              <div class="field">
                <div contenteditable="true">180 deg</div>
              </div>
            </div>
          </div>
  
          <div id="bearing-button" class="example-widget example-button">
            <div>Rotate</div>
          </div>
        </div>
      </div>
    </li>
    <li class="module">
      <h2 class="title">Heading</h2>
      <div class="move-controls"><span class="down">&#x25bc;</span><span class="up">&#x25b2;</span></div>
      <div class="content">
        <div style="margin-bottom: 0.5em">
          <ul id="toggle-button-group-1" class="example-widget example-button-group">
            <li class="example-button example-toggle-button button">
              <div>Auto</div>
            </li>
            <li class="example-button example-toggle-button button selected">
              <div>Manual</div>
            </li>
          </ul>
        </div>
        <div>
          <div id="heading-slider" class="example-widget example-slider" style="margin-right: 0.25em">
            <div class="bar" style="width: 50%;"></div>
            <div class="overlay">
              <div class="decrease">
                <div style="font-size: 0.6em;">&#x25c0;</div>
              </div>
              <div class="label">
                <div>Heading:</div>
              </div>
              <div class="increase">
                <div style="font-size: 0.6em;">&#x25b6;</div>
              </div>
              <div class="field">
                <div contenteditable="true">180 deg</div>
              </div>
            </div>
          </div>
  
          <div id="heading-button" class="example-widget example-button">
            <div>Steer</div>
          </div>
        </div>
      </div>
    </li>
    <li class="module collapsed">
      <h2 class="title">Location</h2>
      <div class="move-controls"><span class="down">&#x25bc;</span><span class="up">&#x25b2;</span></div>
      <div class="content">
        <div class="section">
          <div style="margin-bottom: 0.5em">
            <div class="heading">Rotor</div>
            <ul id="toggle-button-group-1" class="example-widget example-button-group">
              <li class="example-button example-toggle-button button">
                <div>Auto</div>
              </li>
              <li class="example-button example-toggle-button button selected">
                <div>Manual</div>
              </li>
            </ul>
          </div>
          <div>
            <div id="text-box-1" class="example-widget example-text-box" style="width: 15em; margin-right: 0.25em">
              <div class="field">
                <div contenteditable="true"></div>
                <div class="hint">coordinates</div>
              </div>
            </div>
  
            <div id="button-1" class="example-widget example-button">
              <div>Move</div>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="heading">Target:</div>
          <div id="text-box-1" class="example-widget example-text-box" style="width: 15em; margin-right: 0.25em">
            <div class="field">
              <div contenteditable="true"></div>
              <div class="hint">coordinates</div>
            </div>
          </div>
  
          <div id="button-1" class="example-widget example-button">
            <div>Move</div>
          </div>
        </div>
      </div>
    </li>
    <li class="module">
      <h2 class="title">Limits</h2>
      <div class="move-controls"><span class="down">&#x25bc;</span><span class="up">&#x25b2;</span></div>
      <div class="content">
        <div class="section">
          <div class="heading">CCW</div>
          <div id="negative-limit-spin-box" class="example-widget example-spin-box" style="margin-right: 0.25em">
            <div class="decrease">
              <div style="font-size: 0.6em;">&#x25c0;</div>
            </div>
            <div class="field">
              <div contenteditable="true">180 deg</div>
            </div>
            <div class="increase">
              <div style="font-size: 0.6em;">&#x25b6;</div>
            </div>
          </div>
  
          <div id="negative-limit-button" class="example-widget example-button">
            <div>Set</div>
          </div>
        </div>
        <div class="section">
          <div class="heading">CW</div>
          <div id="positive-limit-spin-box" class="example-widget example-spin-box" style="margin-right: 0.25em">
            <div class="decrease">
              <div style="font-size: 0.6em;">&#x25c0;</div>
            </div>
            <div class="field">
              <div contenteditable="true">180 deg</div>
            </div>
            <div class="increase">
              <div style="font-size: 0.6em;">&#x25b6;</div>
            </div>
          </div>
  
          <div id="positive-limit-button" class="example-widget example-button">
            <div>Set</div>
          </div>
        </div>
      </div>
    </li>
  </ol>
</body>
</html>
