<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    body {
      font-family: 'sans-serif';
    }

    #rotor {
      width: 550px;
      height: 550px;
    }

    #circle {
      fill: none;
      stroke: #aaaaee;
      stroke-width: 10;
    }

    #arrow-target {
      transition: transform 0.5s;
    }

    #arrow-target path {
      fill: none;
      stroke: #aaaaee;
      stroke-width: 5;
      stroke-dasharray: 10;
    }

    #arrow-target text {
      fill: #aaaaee;
      font-family: 'sans-serif';
      font-feature-settings: 'onum';
      font-variant-numeric: oldstyle-nums;
      font-weight: bold;
      font-size: 20px;
    }

    #arrow {
      transition: transform 3s;
      transition-timing-function: linear;
    }

    #arrow path {
      fill: #000000;
    }

    #arrow text {
      fill: #ffffff;
      font-family: 'sans-serif';
      font-feature-settings: 'onum';
      font-variant-numeric: oldstyle-nums;
      font-weight: bold;
      font-size: 20px;
    }

    #negative-limit {
      transition: transform 1s;

      fill: #ff0000;
    }

    #positive-limit {
      transition: transform 1s;

      fill: #00ff00;
    }

    #n {
      transition: transform 0.5s;

      fill: #000000;
    }
  </style>
</head>
<body>
  <script type="text/javascript">
    var ws = new WebSocket("ws://" + window.location.hostname + ":2345");
    ws.onmessage = function(event) {
      console.log(event.data);
      rotorToBearing(event.data);
    };
  </script>
  <svg id="rotor"
       xmlns="http://www.w3.org/2000/svg"
       xmlns:svg="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       width="540"
       height="540"
       version="1.1"
  >
    <circle
      id="circle"
      cx="270"
      cy="270"
      r="210"
    />
    <!-- 70 * tan(60deg.) = 121.243557 -->
    <!-- 20 * cos(30deg.) = 17.32051 -->
    <!-- 25 + 17.32051 = 42.32051 -->
    <!-- 121.243557 + 17.32051 + 10 = 148.56406 -->
    <!-- 70 + 17.32051 = 87.32051 -->
    <g id="arrow-target"><g transform="translate(270 270)">
      <path
        d="m -45 -60
           v 140
           h 90
           v -140
           h 42.32051
           l -87.32051,-148.56406
           l -87.32051,148.56406
           z"
      />
      <text x="0" y="-45" text-anchor="middle">0째</text>
    </g></g>
    <g id="arrow"><g transform="translate(270 270)">
      <mask id="target-bearing-window">
        <rect x="-50%" y="-50%" width="100%" height="100%" fill="white" />
        <!-- start node x = (55 * cos(pi * 0.34)) = 26.49645 -->
        <!-- node y = -(55 * sin(pi * 0.34)) = -48.19687 -->
        <!-- end node x = (55 * cos(pi * 0.66)) = -26.49645 -->
        <path
          d="m 26.49645 -48.19687
             A 55 55 0 0 0 -26.49645 -48.1968"
          stroke="black"
          stroke-width="27"
        />
      </mask>
      <path
        d="m -35 -70
           v 140
           h 70
           v -140
           h 35
           l -70,-121.243557
           l -70,121.243557
           z"
        mask="url(#target-bearing-window)"
      />
      <text x="0" y="-75" text-anchor="middle">0째</text>
    </g></g>
    <g id="negative-limit"><rect
      transform="translate(270 270)"
      x="-10"
      y="-225"
      width="20"
      height="30"
    /></g>
    <g id="positive-limit"><rect
      transform="translate(270 270)"
      x="-10"
      y="-225"
      width="20"
      height="30"
    /></g>
    <!-- (40 - x) ^ 2 + 14 ^ 2 = ((14 / 8) * x)^2 -->
    <!-- x = (-640 / 33) + ((56 sqrt(433)) / 33) = 15.91771 -->
    <!-- 40 - 15.91771 = 24.08229 -->
    <g id="n"><path
      transform="translate(270 270)"
      d="m -15 -225
         v -40
         h 8
         l 14,24.08229
         v -24.08229
         h 8
         v 40
         h -8
         l -14,-24.08229
         v 24.08229
         z"
    /></g>
  </svg>
  <script type="text/javascript">
    function sendBearing(bearing) {
        ws.send(bearing); 
    }

    function rotorTargetToBearing(bearing) {
        document.getElementById('arrow-target').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#arrow-target text').textContent = bearing + "째";
    }

    function rotorToBearing(bearing) {
        document.getElementById('arrow').setAttribute("transform", "rotate(" + bearing + " 270 270)");
        document.querySelector('#arrow text').textContent = bearing + "째";
    }

    function negativeLimitToBearing(bearing) {
        document.getElementById('negative-limit').setAttribute("transform", "rotate(" + bearing + " 270 270)");
    }

    function positiveLimitToBearing(bearing) {
        document.getElementById('positive-limit').setAttribute("transform", "rotate(" + bearing + " 270 270)");
    }

    function setHeading(heading) {
        document.getElementById('n').setAttribute("transform", "rotate(" + -heading + " 270 270)");
    }
  </script>
  <br />
  <form onsubmit="rotorToBearing(document.getElementById('bearing').value); rotorTargetToBearing(document.getElementById('bearing').value); return false">
<!--
  <form onsubmit="sendBearing(document.getElementById('bearing').value); return false">
-->
    Bearing:<br />
    <input type="text" id="bearing" autofocus="autofocus" autocomplete="off" /><br />
    <input type="submit" value="Rotate" /><br />
  </form><br />
  <form onsubmit="setHeading(document.getElementById('heading').value); return false">
    Heading:<br />
    <input type="text" id="heading" autocomplete="off" /><br />
    <input type="submit" value="Steer" />
  </form>
</body>
</html>
